const conf = require("../conf/conf.js");
const algoliasearch = require("algoliasearch");
var client = algoliasearch(conf.algoliaId, conf.algoliaKey);
var index1 = client.initIndex('map-pa-'+(conf.paFetchMode==="LIVE"?"live":"test"));
var index2 = client.initIndex('map-parties-'+(conf.paFetchMode==="LIVE"?"live":"test"));
var index3 = client.initIndex("map-constituencies-"+(conf.paFetchMode==="LIVE"?"live":"test"));

var numbersToIds = {
  "1": "W07000049",
  "2": "W07000058",
  "3": "S14000001",
  "4": "S14000002",
  "5": "S14000058",
  "6": "S14000003",
  "7": "E14000530",
  "8": "E14000531",
  "9": "E14000532",
  "10": "W07000043",
  "11": "E14000533",
  "12": "S14000004",
  "13": "N06000005",
  "14": "N06000012",
  "15": "N06000014",
  "16": "W07000057",
  "17": "S14000005",
  "18": "E14000534",
  "19": "E14000535",
  "20": "E14000536",
  "21": "E14000537",
  "22": "E14000538",
  "23": "S14000006",
  "24": "S14000010",
  "25": "S14000048",
  "26": "E14000539",
  "27": "S14000007",
  "28": "E14000540",
  "29": "E14000541",
  "30": "E14000542",
  "31": "E14000543",
  "32": "E14000544",
  "33": "E14000933",
  "34": "E14000545",
  "35": "E14000546",
  "36": "E14000547",
  "37": "E14000548",
  "38": "E14000549",
  "39": "E14000550",
  "40": "E14000551",
  "41": "E14000552",
  "42": "E14000813",
  "43": "E14000841",
  "44": "E14000949",
  "45": "N06000001",
  "46": "N06000002",
  "47": "N06000003",
  "48": "N06000004",
  "49": "E14000553",
  "50": "E14000554",
  "51": "S14000008",
  "52": "E14000555",
  "53": "E14000556",
  "54": "E14000557",
  "55": "E14000558",
  "56": "E14000559",
  "57": "E14000560",
  "58": "E14000561",
  "59": "E14000562",
  "60": "E14000563",
  "61": "E14000564",
  "62": "E14000565",
  "63": "E14000566",
  "64": "E14000567",
  "65": "E14000568",
  "66": "E14000569",
  "67": "E14000570",
  "68": "E14000571",
  "69": "E14000572",
  "70": "E14000573",
  "71": "W07000072",
  "72": "E14000574",
  "73": "E14000575",
  "74": "E14000576",
  "75": "E14000577",
  "76": "E14000578",
  "77": "E14000579",
  "78": "E14000580",
  "79": "E14000581",
  "80": "E14000582",
  "81": "E14000583",
  "82": "E14000584",
  "83": "E14000585",
  "84": "E14000586",
  "85": "E14000587",
  "86": "E14000588",
  "87": "E14000589",
  "88": "E14000590",
  "89": "W07000068",
  "90": "E14000591",
  "91": "E14000592",
  "92": "E14000593",
  "93": "E14000594",
  "94": "W07000073",
  "95": "E14000595",
  "96": "E14000596",
  "97": "E14000597",
  "98": "E14000598",
  "99": "E14000599",
  "100": "E14000600",
  "101": "E14000601",
  "102": "E14000602",
  "103": "E14000603",
  "104": "E14000604",
  "105": "E14000605",
  "106": "E14000606",
  "107": "E14000607",
  "108": "E14000608",
  "109": "E14000609",
  "110": "E14000610",
  "111": "E14000611",
  "112": "E14000612",
  "113": "E14000613",
  "114": "W07000076",
  "115": "S14000009",
  "116": "E14000614",
  "117": "E14000615",
  "118": "E14000616",
  "119": "E14000617",
  "120": "E14000842",
  "121": "E14000855",
  "122": "E14000934",
  "123": "E14000937",
  "124": "E14000618",
  "125": "E14000619",
  "126": "W07000050",
  "127": "W07000051",
  "128": "W07000080",
  "129": "W07000079",
  "130": "E14000620",
  "131": "W07000067",
  "132": "W07000066",
  "133": "E14000621",
  "134": "E14000622",
  "135": "W07000064",
  "136": "E14000625",
  "137": "E14000626",
  "138": "E14000627",
  "139": "E14000628",
  "140": "E14000629",
  "141": "E14000630",
  "142": "E14000631",
  "143": "E14000640",
  "144": "E14000632",
  "145": "E14000633",
  "146": "E14000634",
  "147": "E14000635",
  "148": "E14000636",
  "149": "E14000637",
  "150": "E14000638",
  "151": "E14000639",
  "152": "E14000642",
  "153": "E14000643",
  "154": "W07000062",
  "155": "W07000059",
  "156": "S14000011",
  "157": "E14000644",
  "158": "E14000645",
  "159": "E14000646",
  "160": "E14000647",
  "161": "E14000648",
  "162": "E14000837",
  "163": "E14000938",
  "164": "E14000991",
  "165": "E14000649",
  "166": "E14000650",
  "167": "E14000651",
  "168": "E14000652",
  "169": "E14000653",
  "170": "E14000654",
  "171": "E14000655",
  "172": "E14000656",
  "173": "S14000012",
  "174": "W07000070",
  "175": "E14000657",
  "176": "E14000658",
  "177": "E14000659",
  "178": "E14000660",
  "179": "W07000042",
  "180": "E14000661",
  "181": "E14000662",
  "182": "E14000663",
  "183": "E14000664",
  "184": "E14000814",
  "185": "E14000843",
  "186": "E14000935",
  "187": "E14000665",
  "188": "E14000623",
  "189": "E14000678",
  "190": "E14000838",
  "191": "E14000950",
  "192": "E14001000",
  "193": "E14000666",
  "194": "E14000667",
  "195": "E14000668",
  "196": "E14000669",
  "197": "E14000815",
  "198": "E14000839",
  "199": "E14000936",
  "200": "E14001031",
  "201": "E14000670",
  "202": "N06000013",
  "203": "N06000015",
  "204": "E14000671",
  "205": "E14000672",
  "206": "E14000673",
  "207": "S14000013",
  "208": "S14000014",
  "209": "S14000018",
  "210": "S14000059",
  "211": "S14000015",
  "212": "S14000016",
  "213": "S14000017",
  "214": "E14000641",
  "215": "E14000840",
  "216": "E14000856",
  "217": "W07000061",
  "218": "E14000674",
  "219": "E14000675",
  "220": "E14000676",
  "221": "E14000677",
  "222": "E14000679",
  "223": "S14000019",
  "224": "S14000020",
  "225": "E14000684",
  "226": "E14000685",
  "227": "E14000686",
  "228": "S14000022",
  "229": "S14000023",
  "230": "S14000024",
  "231": "S14000025",
  "232": "S14000026",
  "233": "E14000687",
  "234": "E14000688",
  "235": "E14000689",
  "236": "E14000690",
  "237": "E14000691",
  "238": "E14000692",
  "239": "E14000693",
  "240": "E14000694",
  "241": "E14000695",
  "242": "E14000696",
  "243": "E14000697",
  "244": "E14000698",
  "245": "S14000028",
  "246": "E14000699",
  "247": "E14000700",
  "248": "E14000701",
  "249": "N06000007",
  "250": "S14000049",
  "251": "E14000702",
  "252": "E14000703",
  "253": "E14000704",
  "254": "E14000705",
  "255": "N06000008",
  "256": "E14000706",
  "257": "E14000707",
  "258": "E14000708",
  "259": "E14000709",
  "260": "E14000710",
  "261": "E14000711",
  "262": "S14000029",
  "263": "S14000030",
  "264": "S14000031",
  "265": "S14000032",
  "266": "S14000033",
  "267": "S14000034",
  "268": "S14000035",
  "269": "S14000036",
  "270": "E14000712",
  "271": "S14000037",
  "272": "E14000713",
  "273": "W07000046",
  "274": "E14000714",
  "275": "E14000715",
  "276": "E14000716",
  "277": "E14000717",
  "278": "E14000718",
  "279": "E14000719",
  "280": "E14000720",
  "281": "E14000721",
  "282": "E14000722",
  "283": "E14000723",
  "284": "E14000724",
  "285": "E14000725",
  "286": "E14000726",
  "287": "E14000680",
  "288": "E14000844",
  "289": "E14000857",
  "290": "E14000727",
  "291": "E14000728",
  "292": "E14000729",
  "293": "E14000730",
  "294": "E14000731",
  "295": "E14000732",
  "296": "E14000733",
  "297": "E14000734",
  "298": "E14000735",
  "299": "E14000736",
  "300": "E14000737",
  "301": "E14000738",
  "302": "E14000739",
  "303": "E14000740",
  "304": "E14000741",
  "305": "E14000742",
  "306": "E14000743",
  "307": "E14000847",
  "308": "E14000744",
  "309": "E14000845",
  "310": "E14000951",
  "311": "E14000745",
  "312": "E14000746",
  "313": "E14000747",
  "314": "E14000748",
  "315": "E14000749",
  "316": "E14000750",
  "317": "E14000751",
  "318": "E14000752",
  "319": "E14000753",
  "320": "E14000754",
  "321": "E14000755",
  "322": "E14000756",
  "323": "E14000771",
  "324": "E14000772",
  "325": "E14000773",
  "326": "E14000757",
  "327": "E14000758",
  "328": "E14000759",
  "329": "E14000760",
  "330": "S14000038",
  "331": "S14000039",
  "332": "E14000761",
  "333": "E14000762",
  "334": "E14000763",
  "335": "E14000764",
  "336": "W07000077",
  "337": "E14000765",
  "338": "E14000766",
  "339": "E14000767",
  "340": "E14000768",
  "341": "E14000769",
  "342": "S14000040",
  "343": "E14000770",
  "344": "E14000774",
  "345": "S14000041",
  "346": "E14000775",
  "347": "N06000009",
  "348": "S14000042",
  "349": "E14001033",
  "350": "E14000776",
  "351": "E14000777",
  "352": "E14000778",
  "353": "E14000779",
  "354": "E14000780",
  "355": "E14000781",
  "356": "E14000782",
  "357": "E14000783",
  "358": "E14000784",
  "359": "E14000858",
  "360": "E14000940",
  "361": "E14000785",
  "362": "E14000786",
  "363": "E14000789",
  "364": "E14000787",
  "365": "E14000788",
  "366": "E14000790",
  "367": "E14000791",
  "368": "E14000792",
  "369": "S14000043",
  "370": "E14000793",
  "371": "E14000794",
  "372": "E14000795",
  "373": "E14000796",
  "374": "S14000044",
  "375": "W07000045",
  "376": "N06000006",
  "377": "E14000797",
  "378": "E14000798",
  "379": "E14000799",
  "380": "E14000800",
  "381": "E14000801",
  "382": "E14000802",
  "383": "E14000803",
  "384": "E14000804",
  "385": "E14000805",
  "386": "E14000806",
  "387": "E14000807",
  "388": "E14000808",
  "389": "E14000809",
  "390": "E14000810",
  "391": "E14000811",
  "392": "E14000812",
  "393": "W07000071",
  "394": "E14000819",
  "395": "E14000820",
  "396": "S14000045",
  "397": "E14000821",
  "398": "E14000822",
  "399": "E14000823",
  "400": "E14000824",
  "401": "W07000054",
  "402": "W07000063",
  "403": "S14000046",
  "404": "E14000825",
  "405": "E14000826",
  "406": "S14000047",
  "407": "S14000027",
  "408": "W07000069",
  "409": "E14000827",
  "410": "E14000828",
  "411": "E14000829",
  "412": "E14000830",
  "413": "E14000834",
  "414": "E14000831",
  "415": "E14000832",
  "416": "E14000833",
  "417": "W07000055",
  "418": "W07000056",
  "419": "N06000011",
  "420": "E14000835",
  "421": "E14000816",
  "422": "E14000848",
  "423": "E14000859",
  "424": "E14000941",
  "425": "E14000952",
  "426": "E14000836",
  "427": "E14000861",
  "428": "E14000862",
  "429": "E14000942",
  "430": "E14000863",
  "431": "E14000864",
  "432": "E14000865",
  "433": "E14000866",
  "434": "E14000867",
  "435": "E14000868",
  "436": "S14000050",
  "437": "W07000074",
  "438": "E14000869",
  "439": "E14000870",
  "440": "E14000871",
  "441": "S14000051",
  "442": "E14000872",
  "443": "E14000873",
  "444": "E14000874",
  "445": "S14000052",
  "446": "S14000053",
  "447": "E14000875",
  "448": "E14000876",
  "449": "E14000877",
  "450": "S14000054",
  "451": "E14000878",
  "452": "E14000879",
  "453": "E14000880",
  "454": "W07000075",
  "455": "E14000881",
  "456": "E14000882",
  "457": "E14000883",
  "458": "E14000884",
  "459": "W07000065",
  "460": "E14000885",
  "461": "E14000886",
  "462": "E14000887",
  "463": "E14000888",
  "464": "E14000889",
  "465": "E14000890",
  "466": "E14000891",
  "467": "E14000892",
  "468": "E14000893",
  "469": "S14000021",
  "470": "W07000052",
  "471": "E14000894",
  "472": "E14000895",
  "473": "E14000896",
  "474": "E14000897",
  "475": "E14000898",
  "476": "E14000899",
  "477": "E14000900",
  "478": "E14000901",
  "479": "S14000055",
  "480": "E14000902",
  "481": "E14000903",
  "482": "E14000904",
  "483": "E14000905",
  "484": "E14000906",
  "485": "E14000907",
  "486": "E14000908",
  "487": "S14000056",
  "488": "E14000909",
  "489": "E14000910",
  "490": "E14000960",
  "491": "E14000961",
  "492": "E14000962",
  "493": "E14000963",
  "494": "E14000964",
  "495": "E14000911",
  "496": "E14000912",
  "497": "E14000913",
  "498": "E14000914",
  "499": "E14000915",
  "500": "E14000916",
  "501": "E14000917",
  "502": "E14000918",
  "503": "E14000921",
  "504": "E14000919",
  "505": "E14000922",
  "506": "E14000923",
  "507": "E14000920",
  "508": "E14000924",
  "509": "E14000925",
  "510": "E14000926",
  "511": "E14000849",
  "512": "E14000927",
  "513": "E14000928",
  "514": "E14000929",
  "515": "E14000930",
  "516": "E14000931",
  "517": "E14000850",
  "518": "E14000846",
  "519": "E14000932",
  "520": "E14000939",
  "521": "E14000943",
  "522": "E14000944",
  "523": "E14000955",
  "524": "E14000956",
  "525": "E14000957",
  "526": "E14000958",
  "527": "E14000959",
  "528": "E14000965",
  "529": "E14000966",
  "530": "E14000945",
  "531": "E14000967",
  "532": "E14000968",
  "533": "S14000057",
  "534": "E14000969",
  "535": "E14000970",
  "536": "E14000971",
  "537": "E14000972",
  "538": "E14000973",
  "539": "E14000974",
  "540": "E14000975",
  "541": "E14000976",
  "542": "N06000016",
  "543": "E14000977",
  "544": "E14000978",
  "545": "E14000979",
  "546": "E14000980",
  "547": "E14000624",
  "548": "E14000981",
  "549": "E14000946",
  "550": "E14001034",
  "551": "E14000982",
  "552": "E14000681",
  "553": "E14000983",
  "554": "E14000953",
  "555": "E14000817",
  "556": "E14000984",
  "557": "E14000985",
  "558": "W07000048",
  "559": "W07000047",
  "560": "E14000851",
  "561": "E14000947",
  "562": "E14000986",
  "563": "E14000987",
  "564": "E14000988",
  "565": "E14000989",
  "566": "E14000990",
  "567": "E14000852",
  "568": "E14000948",
  "569": "E14000993",
  "570": "E14000994",
  "571": "E14000995",
  "572": "E14000996",
  "573": "E14000997",
  "574": "E14000998",
  "575": "E14000999",
  "576": "W07000053",
  "577": "E14001001",
  "578": "E14001002",
  "579": "E14001003",
  "580": "E14001004",
  "581": "E14001005",
  "582": "E14001006",
  "583": "E14000853",
  "584": "N06000018",
  "585": "N06000010",
  "586": "N06000017",
  "587": "E14001007",
  "588": "W07000060",
  "589": "W07000078",
  "590": "E14001008",
  "591": "E14001009",
  "592": "E14001010",
  "593": "E14001011",
  "594": "E14001012",
  "595": "E14001013",
  "596": "E14001014",
  "597": "E14001015",
  "598": "E14001016",
  "599": "E14001017",
  "600": "E14001018",
  "601": "E14001019",
  "602": "E14000854",
  "603": "E14001020",
  "604": "E14001021",
  "605": "E14001022",
  "606": "E14001023",
  "607": "E14001024",
  "608": "E14001025",
  "609": "E14001026",
  "610": "E14001027",
  "611": "E14001028",
  "612": "E14001029",
  "613": "E14001030",
  "614": "E14001032",
  "615": "E14001036",
  "616": "E14001037",
  "617": "E14001038",
  "618": "E14001039",
  "619": "E14000860",
  "620": "E14000954",
  "621": "E14001040",
  "622": "E14001041",
  "623": "E14001042",
  "624": "E14001043",
  "625": "E14001044",
  "626": "E14001045",
  "627": "E14001046",
  "628": "E14001047",
  "629": "E14001048",
  "630": "E14001049",
  "631": "E14001050",
  "632": "E14001051",
  "633": "E14001052",
  "634": "E14000818",
  "635": "E14001035",
  "636": "E14001053",
  "637": "E14001054",
  "638": "E14000682",
  "639": "E14001055",
  "640": "E14000992",
  "641": "W07000044",
  "642": "E14001056",
  "643": "E14001057",
  "644": "E14001058",
  "645": "E14001059",
  "646": "E14001060",
  "647": "W07000041",
  "648": "E14001061",
  "649": "E14001062",
  "650": "E14000683"
}

module.exports = {

  // Do not forget to include DB client here

  updateSop: function (sopJSON,done){
    // Do something with sopJSON here, for example update in DB
    // Call done() once done

    // console.log(sopJSON)

    var summary = sopJSON.FirstPastThePostStateOfParties.$;
    summary.objectID = 'summary';
    var parties = sopJSON.FirstPastThePostStateOfParties.Parties[0].Party;

    index1.saveObject(summary);
    index2.clearIndex(function(err) {
      if (err) {
        console.error(err);
        return;
      }
      parties.forEach(function(party) {
        party.$.objectID = party.$.paId;
        index2.saveObject(party.$);
      });
    });
    done();
  },

  updateConstituency: function (constituencyJSON,done){
    // Do something with constituencyJSON here, for example update in DB
    // Call done() once done

    // console.log(constituencyJSON)

    const constituency = constituencyJSON.FirstPastThePostResult.Election[0].Constituency[0];
    const objectID = numbersToIds[constituency.$.number];
    const candidates = constituency.Candidate
    const parties = [];
    candidates.forEach(function(candidate){
      const party = candidate.Party[0];
      parties.push({
        party: party.$.name.toLowerCase().replace(/\s/g,"-"),
        rank: parties.length+1,
        votes: party.$.votes,
        candidate: candidate.$.firstName + " " + candidate.$.surname,
        name: party.$.name,
        share: party.$.percentageShare,
        shareChange: party.$.percentageShareChange,
      })
    });
    const toUpdateObj = {
      objectID: objectID,
      name: constituency.$.name,
      results: parties,
    };

    index3.partialUpdateObject(
      toUpdateObj, function(err, content) {
      if (err) {
        console.error(err);
        return;
      }
    });
    done();
  }

}
